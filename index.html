<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:800|Roboto' rel='stylesheet' type='text/css'>
<style>

.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .03;
}

.link:hover {
  stroke-opacity: .5;
}

svg {
                display: block;
                margin: auto;
}

text {
	font-family: 'Roboto', sans-serif;
	}


</style>
<body>

 <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">GarViz</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Help</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
          <ul class="nav nav-sidebar">
            <li>
				<label class="control-label">Location</label>
				<select id="locationfilter" class="form-control filter">
					<option value="USA">United States</option>
					<option value="SWE">Sweden</option>
					<option value="BRA">Brazil</option>
				</select>
			</li>
            <li>
				<label class="control-label">Year</label>
				<select id="yearfilter" class="form-control filter">
					<option value=2008>2008</option>
				</select>
			</li>
			<li>
				<label class="control-label">Sex</label>
				<select id="sexfilter" class="form-control filter">
					<option value=1>Males</option>
					<option value=2>Females</option>
				</select>
			</li>
			<li>
				<label class="control-label">Age</label>
				<select id="agefilter" class="form-control filter">
					<option value=99>All Ages</option>
				</select>
			</li>
		  </ul>
		  <ul class="nav nav-sidebar">
			<li>
				<label class="control-label filter">Package</label>
				<select id="nodefilter" class="form-control filter">
					<option value="0">Overview</option>
					<option value="1">Package 1</option>
					<option value="2">Package 2</option>
					<option value="3">Package 3</option>
					<option value="4">Package 4</option>
					<option value="5">Package 5</option>
					<option value="6">Unspecified STD</option>
					<option value="7">Package 7</option>
					<option value="8">Package 8</option>
					<option value="9">Package 10</option>
					<option value="10">Package 11</option>
					<option value="11">Package 12</option>
					<option value="12">Package 13</option>
					<option value="13">Package 14</option>
					<option value="14">Package 15</option>
					<option value="15">Package 16</option>
					<option value="16">Package 17</option>
					<option value="17">Package 19</option>
					<option value="18">Package 20</option>
					<option value="19">Package 21</option>
					<option value="20">Package 22</option>
					<option value="21">Package 23</option>
					<option value="22">Package 24</option>
					<option value="23">Package 25</option>
					<option value="24">Package 26</option>
					<option value="25">Package 27</option>
					<option value="26">Package 28</option>
					<option value="27">Package 29</option>
					<option value="28">Package 31</option>
					<option value="30">Package 32</option>
					<option value="31">Package 33</option>
					<option value="32">Package 34</option>
					<option value="33">Package 35</option>
					<option value="34">Package 36</option>
					<option value="35">Package 37</option>
					<option value="36">Package 38</option>
					<option value="37">Package 39</option>
					<option value="38">Package 40</option>
					<option value="39">Package 41</option>
					<option value="40">Package 42</option>
					<option value="41">Package 43</option>
					<option value="42">Package 50</option>
					<option value="43">Package 88</option>
					<option value="44">Package 89</option>
					<option value="45">Package 90</option>
					<option value="46">Package 91</option>
					<option value="47">Package 92</option>
					<option value="48">Package 93</option>
					<option value="49">Package 94</option>
					<option value="50">Package 95</option>
					<option value="51">Package 96</option>
					<option value="52">Package 97</option>
					<option value="53">Package 98</option>
					<option value="54">Package 99</option>
					<option value="55">Package 100</option>
					<option value="56">Package 101</option>
					<option value="57">Package 44</option>
					<option value="58">Package 46</option>
					<option value="59">Package 47</option>
					<option value="60">Package 48</option>
					<option value="61">Package 49</option>
					<option value="62">Package 51</option>
					<option value="63">Package 52</option>
					<option value="64">Package 53</option>
					<option value="65">Package 54</option>
					<option value="66">Package 55</option>
					<option value="67">Package 56</option>
					<option value="68">Package 57</option>
					<option value="69">Package 58</option>
					<option value="70">Package 59</option>
					<option value="71">Package 60</option>
					<option value="72">Package 61</option>
					<option value="73">Package 62</option>
					<option value="74">Package 63</option>
					<option value="75">Package 64</option>
					<option value="76">Package 65</option>
					<option value="77">Package 66</option>
					<option value="78">Package 67</option>
					<option value="79">Package 68</option>
					<option value="80">Package 69</option>
					<option value="81">Package 70</option>
					<option value="82">Package 71</option>
					<option value="83">Package 72</option>
					<option value="84">Package 73</option>
					<option value="85">Package 74</option>
					<option value="86">Package 75</option>
					<option value="87">Package 76</option>
					<option value="88">Package 77</option>
					<option value="89">Package 78</option>
					<option value="90">Package 79</option>
					<option value="91">Package 80</option>
					<option value="92">Package 81</option>
					<option value="93">Package 82</option>
					<option value="94">Package 83</option>
					<option value="95">Package 84</option>
					<option value="96">Package 85</option>
					<option value="97">Package 86</option>
					<option value="98">Package 87</option>
					<option value="99">Package atro_1</option>
					<option value="100">Package bp_1</option>
					<option value="101">Package hf_1</option>
					<option value="102">Package interm_104</option>
					<option value="103">Package interm_105</option>
					<option value="104">Package interm_105_1</option>
					<option value="105">Package interm_107</option>
					<option value="106">Package interm_108</option>
					<option value="107">Package interm_109</option>
					<option value="108">Package interm_110</option>
					<option value="109">Package interm_115</option>
					<option value="110">Package interm_116</option>
					<option value="111">Package interm_117</option>
					<option value="112">Package interm_118</option>
					<option value="113">Package interm_119</option>
					<option value="114">Package interm_120</option>
					<option value="115">Package interm_127</option>
					<option value="116">Package interm_128</option>
					<option value="117">Package interm_132</option>
					<option value="118">Package interm_133</option>
					<option value="119">Package interm_136</option>
					<option value="120">Package interm_137</option>
					<option value="121">Package interm_140</option>
					<option value="123">Package interm_143</option>
					<option value="124">Package interm_144</option>
					<option value="125">Package interm_145</option>
					<option value="126">Package interm_146</option>
					<option value="127">Package interm_148</option>
					<option value="128">Package interm_149</option>
					<option value="129">Package interm_150</option>
					<option value="130">Package interm_151</option>
					<option value="131">Package interm_152</option>
					<option value="132">Package interm_168</option>
					<option value="133">Package interm_184</option>
					<option value="134">Package interm_185</option>
					<option value="135">Package interm_187</option>
					<option value="136">Package interm_194</option>
					<option value="137">Package interm_205</option>
					<option value="138">Package interm_206</option>
					<option value="139">Package interm_207</option>
					<option value="140">Package interm_207_1</option>
					<option value="141">Package interm_208</option>
					<option value="142">Package interm_209</option>
					<option value="143">Package interm_210</option>
					<option value="144">Package interm_211</option>
					<option value="145">Package interm_212</option>
					<option value="146">Package interm_213</option>
					<option value="147">Package interm_214</option>
					<option value="148">Package interm_215</option>
					<option value="149">Package interm_216</option>
					<option value="150">Package interm_217</option>
					<option value="151">Package interm_218</option>
					<option value="152">Package interm_219</option>
					<option value="153">Package interm_219_1</option>
					<option value="154">Package interm_52</option>
					<option value="155">Package interm_54</option>
					<option value="156">Package interm_55</option>
					<option value="157">Package interm_56</option>
					<option value="158">Package interm_59</option>
					<option value="159">Package interm_60</option>
					<option value="160">Package interm_61</option>
					<option value="161">Package interm_63</option>
					<option value="162">Package interm_64</option>
					<option value="163">Package interm_65</option>
					<option value="164">Package interm_66</option>
					<option value="165">Package interm_67</option>
					<option value="166">Package interm_70</option>
					<option value="167">Package interm_71</option>
					<option value="168">Package interm_72</option>
					<option value="169">Package interm_73</option>
					<option value="170">Package interm_74</option>
					<option value="171">Package interm_75</option>
					<option value="172">Package stroke_30</option>
					<option value="173">Package all_garbage</option>
				</select>
			</li>
			<li>
				<label class="control-label filter">Aggregation</label>
				<select id="aggregationfilter" class="form-control filter">
					<option value=1>Level 1 Aggregation</option>
					<option value=2>Level 2 Aggregation</option>
					<option value=3>Level 3 Aggregation</option>
					<option value=4>Level 4 Aggregation</option>
					<option value=5>Most detailed</option>
				</select>
			</li>
          </ul>
		  
        </div>
		
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
		  
		  <div class="row col-md-12">
            <h2 id="totdeaths"></h2>
			<div id="chart"></div>
          </div>

          
          
        </div>
      </div>
    </div>

<p id="chart">

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="js/sankey.js"></script>
<script src="lib/poshytip/jquery.poshytip.js"></script>
<script src="lib/poshytip/jquery.poshytip.js"></script>
	
<script>
	
var units = "Cases";

var margin = {top: 200, right: 350, bottom: 10, left: 350},
    width = 1500 - margin.left - margin.right,
    height = 2200 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scale.category20();

// append the svg canvas to the page
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");

// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(60)
    .nodePadding(0)
    .size([width, height]);

var path = sankey.link();

// Draw axis labels
var drawAxisLabels = function() {
	// title
	title = d3.select('svg').append('text').text('Injury Incidence').attr("x", (width+margin.left+margin.right)/2).attr("y", margin.top/2).attr("font-size", 75).attr("text-anchor", "middle")
	
	ecodetitle = d3.select('svg').append('text').text('E-Codes').attr("x", margin.left).attr("y", margin.top-40).attr("text-anchor", "start").attr("font-size", 40)
	ecodetitle = d3.select('svg').append('text').text('(The "event" resulting in injury)').attr("x", margin.left).attr("y", margin.top-15).attr("text-anchor", "start").attr("font-size", 15)
	
	ncodetitle = d3.select('svg').append('text').text('N-Codes').attr("x", width + margin.left).attr("y", margin.top-40).attr("text-anchor", "end").attr("font-size", 40)
	ncode_explanation = d3.select('svg').append('text').text('(The "nature" of the injury)').attr("x", width + margin.left).attr("y", margin.top-15).attr("text-anchor", "end").attr("font-size", 15)
}

drawAxisLabels()

// Define functions
 // FUNCTION TO HIGHLIGHT ALL LINKS CONNECTED TO A NODE
  function highlight_node_links(node,i){

    var remainingNodes=[],
        nextNodes=[];

    var stroke_opacity = 0.03;
    if( d3.select(this).attr("data-clicked") == "1" ){
      d3.select(this).attr("data-clicked","0");
      stroke_opacity = 0.03;
    }else{
      d3.select(this).attr("data-clicked","1");
      stroke_opacity = 0.5;
    }
	console.log("test", i, node)
    var traverse = [{
                      linkType : "sourceLinks",
                      nodeType : "target"
                    },{
                      linkType : "targetLinks",
                      nodeType : "source"
                    }];

    traverse.forEach(function(step){
      node[step.linkType].forEach(function(link) {
        remainingNodes.push(link[step.nodeType]);
        highlight_link(link.id, stroke_opacity);
      });

      while (remainingNodes.length) {
        nextNodes = [];
        remainingNodes.forEach(function(node) {
          node[step.linkType].forEach(function(link) {
            nextNodes.push(link[step.nodeType]);
            highlight_link(link.id, stroke_opacity);
          });
        });
        remainingNodes = nextNodes;
      }
    });
  }

  function highlight_link(id,opacity){
      d3.select("#link-"+id).style("stroke-opacity", opacity);
  }
  
// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + d.x + "," + (
                d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }  
  
  
var linkFunc = function(link) {
      link.attr("class", "link")
	  .attr("id", function(d,i){
        d.id = i;
        return "link-"+i;
		})
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });
}

var nodeRectFunc = function(node) {
  node
        .attr("class", "node")
    .attr("transform", function(d) { 
		  return "translate(" + d.x + "," + d.y + ")"; })
	.on("click", highlight_node_links)
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { 
		  this.parentNode.appendChild(this); })
      .on("drag", dragmove))
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { 
		  return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { 
		  return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { 
		  return d.name + "\n" + format(d.value); });
}

  
// load the data (using the timelyportfolio csv method)
draw = function(url) {
d3.csv(url, function(error, data) {

  //set up graph in same style as original example but empty
  graph = {"nodes" : [], "links" : []};

    data.forEach(function (d) {
      graph.nodes.push({ "name": d.source });
      graph.nodes.push({ "name": d.target });
      graph.links.push({ "source": d.source,
                         "target": d.target,
                         "value": +d.value });
     });

     // return only the distinct / unique nodes
     graph.nodes = d3.keys(d3.nest()
       .key(function (d) { return d.name; })
       .map(graph.nodes));

     // loop through each link replacing the text with its index from node
     graph.links.forEach(function (d, i) {
       graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
       graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
     });

     //now loop through each nodes to make nodes an array of objects
     // rather than an array of strings
     graph.nodes.forEach(function (d, i) {
       graph.nodes[i] = { "name": d };
     });

  sankey
    .nodes(graph.nodes)
    .links(graph.links)
    .layout(32);

// add in the links
  var link = svg.append("g").selectAll(".link")
      .data(graph.links, function(d) {return d.id})
	  
	link.enter().append("path").call(linkFunc)
	
	link.exit().remove();
		
	svg.append("g").selectAll(".link").transition().duration(500).call(linkFunc);  
	  
// add the link titles
  link.append("title")
        .text(function(d) {
    		return d.source.name + " : " + 
                d.target.name + "\n" + format(d.value); });

// add in the nodes
  var nodeRects = svg.append("g").selectAll(".node")
      .data(graph.nodes, function(d) {return d.id})

	nodeRects.enter().append("rect").call(nodeRectFunc)

	nodeRects.exit().remove();
		
	svg.append("g").selectAll(".node").transition().duration(500).call(nodeRectFunc);	  
		  
// add in the title for the nodes
  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x > width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");
	
});
}

draw("sankey.csv")

</script>

</body>
</html>
